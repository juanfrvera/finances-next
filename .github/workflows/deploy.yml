name: Deploy to AWS

on:
  # Deploy on push to main branch
  push:
    branches: [ main ]
  
  # Deploy on pull request merge
  pull_request:
    branches: [ main ]
    types: [ closed ]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: finances-next
  IMAGE_TAG: latest

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    # Only run on merged PRs or direct pushes to main
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Create ECR repository if it doesn't exist
      run: |
        # Get AWS Account ID
        AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        echo "AWS Account ID: $AWS_ACCOUNT_ID"
        
        aws ecr describe-repositories --repository-names $ECR_REPOSITORY || \
        aws ecr create-repository --repository-name $ECR_REPOSITORY --region $AWS_REGION

    - name: Build, tag, and push image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_URI: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
      run: |
        echo "üî® Building Docker image..."
        docker build \
          -f deploy/Dockerfile \
          -t $IMAGE_URI \
          --build-arg DB_URL="${{ secrets.DB_URL }}" \
          --build-arg DB_NAME="${{ secrets.DB_NAME }}" \
          .
        
        echo "üì§ Pushing image to ECR..."
        docker push $IMAGE_URI
        
        echo "‚úÖ Image pushed successfully!"
        echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

    - name: Deploy App Runner Service
      run: |
        echo "üöÄ Starting App Runner deployment..."
        
        STACK_NAME="finances-next-apprunner-prod"
        TEMPLATE_FILE="deploy/apprunner-template.yaml"
        
        echo "üîÑ Deploying App Runner service..."
        aws cloudformation deploy \
          --template-file $TEMPLATE_FILE \
          --stack-name $STACK_NAME \
          --parameter-overrides \
            ContainerImageUri="${{ env.IMAGE_URI }}" \
            DBUrl="${{ secrets.DB_URL }}" \
            DBName="${{ secrets.DB_NAME }}" \
            Environment=prod \
            MaxInstances=1 \
          --capabilities CAPABILITY_IAM \
          --region ${{ env.AWS_REGION }}

    - name: Get App Runner Service URL
      run: |
        STACK_NAME="finances-next-apprunner-prod"
        
        # Get the service URL from CloudFormation outputs
        SERVICE_URL=$(aws cloudformation describe-stacks \
          --stack-name $STACK_NAME \
          --query 'Stacks[0].Outputs[?OutputKey==`AppRunnerServiceUrl`].OutputValue' \
          --output text)
        
        echo "üåê App Runner Service URL: $SERVICE_URL"
        echo "::notice title=Deployment Success::App Runner service deployed at $SERVICE_URL"

    - name: Health Check
      run: |
        STACK_NAME="finances-next-apprunner-prod"
        
        # Get the service URL
        SERVICE_URL=$(aws cloudformation describe-stacks \
          --stack-name $STACK_NAME \
          --query 'Stacks[0].Outputs[?OutputKey==`AppRunnerServiceUrl`].OutputValue' \
          --output text)
        
        # Wait for service to be ready and perform health check
        echo "‚è≥ Waiting for service to be ready..."
        sleep 30
        
        HEALTH_URL="${SERVICE_URL}/api/health"
        echo "üîç Performing health check at: $HEALTH_URL"
        
        # Try health check with retries
        for i in {1..5}; do
          if curl -f -s "$HEALTH_URL" > /dev/null; then
            echo "‚úÖ Health check passed!"
            curl -s "$HEALTH_URL" | jq '.'
            break
          else
            echo "‚è≥ Health check attempt $i failed, retrying in 10 seconds..."
            sleep 10
          fi
          
          if [ $i -eq 5 ]; then
            echo "‚ùå Health check failed after 5 attempts"
            exit 1
          fi
        done
